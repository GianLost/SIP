@using MudBlazor
@using SIP.UI.Domain.Services.Sectors
@using SIP.UI.Domain.Services.Users
@using SIP.UI.Domain.Enums
@using SIP.UI.Models.Protocols
@using SIP.UI.Models.Users
@using SIP.UI.Models.Sectors

@inject SectorService SectorService
@inject UserService UserService

@inject ISnackbar Snackbar

<MudDialog Style="width:600px">

    @* Conteúdo do diálogo *@
    <DialogContent>

        @* Formulário de edição *@
        <MudForm @ref="form" @bind-IsValid="isValid" Model="_protocol">

            <MudGrid Spacing="2">

                @* Campo assunto *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_protocol.Subject" Label="Assunto" For="() => _protocol.Subject" Required="true" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                @* Campo descrição *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_protocol.Description" Label="Descrição" For="() => _protocol.Description" Required="true" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                @* Caixa de seleção para selecionar o setor de origem *@
                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="Sector"
                                     @bind-Value="SelectedOriginSector"
                                     Label="Setor de Origem"
                                     SearchFunc="SearchSectors"
                                     For="() => SelectedOriginSector"
                                     Required="true"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Normal"
                                     ToStringFunc="@(s => s == null ? null : $"{s.Name} ({s.Acronym})")"
                                     Clearable="true"
                                     Placeholder="Pesquisar setor..."
                                     MaxItems="int.MaxValue" />
                </MudItem>

                @* Caixa de seleção para selecionar o usuário criador 
                    (** TODO: Deverá ser substituido para uma caixa comum contendo o usuário da sessão após implementação de sessão e autenticação de usuários. **)
                *@
                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="User"
                                     @bind-Value="SelectedCreator"
                                     Label="Criado Por"
                                     SearchFunc="SearchUsersForOrigin"
                                     For="() => SelectedCreator"
                                     Required="true"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Normal"
                                     Clearable="true"
                                     Placeholder="Pesquisar usuário..."
                                     ToStringFunc="@(u => u?.FullName)"
                                     Disabled="SelectedOriginSector is null"
                                     MaxItems="int.MaxValue" />
                </MudItem>

                @* Caixa de seleção para selecionar o setor de destino *@
                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="Sector"
                                     @bind-Value="SelectedDestinationSector"
                                     Label="Setor de Destino"
                                     SearchFunc="SearchSectors"
                                     For="() => SelectedDestinationSector"
                                     Required="true"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Normal"
                                     ToStringFunc="@(s => s == null ? null : $"{s.Name} ({s.Acronym})")"
                                     Clearable="true"
                                     Placeholder="Pesquisar setor..."
                                     MaxItems="int.MaxValue" />
                </MudItem>

                @* Caixa de seleção para selecionar o usuário de destino *@
                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="User"
                                     @bind-Value="SelectedDestinationUser"
                                     Label="Destinado a"
                                     SearchFunc="SearchUsersForDestination"
                                     For="() => SelectedDestinationUser"
                                     Required="true"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Normal"
                                     Clearable="true"
                                     Placeholder="Pesquisar usuário..."
                                     ToStringFunc="@(u => u?.FullName)"
                                     Disabled="SelectedDestinationSector is null"
                                     MaxItems="int.MaxValue" />
                </MudItem>

                @* Caixa de seleção para selecionar o status 
                    (** TODO: Deverá ser retirado ao realizar a implementação da tramitação de protocolos **)
                *@
                <MudItem xs="12" sm="6">
                    <MudSelect T="ProtocolStatus" Label="Status" @bind-Value="_protocol.Status" For="() => _protocol.Status" Required="true" Variant="Variant.Outlined" Margin="Margin.Normal">
                        @* Percorre o enum para mapear nomes amigáveis aos status *@
                        @foreach (ProtocolStatus status in Enum.GetValues(typeof(ProtocolStatus)))
                        {
                            <MudSelectItem Value="status">@GetStatusDisplayName(status)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* Caixa de verificação para definir o arquivamento do protocolo
                    (** TODO: Deverá ser retirado ao realizar a implementação automação da finalização da tramitação de protocolos quando se encerra o ciclo de vida. **)
                *@
                <MudItem xs="12" sm="6" Class="m-0">
                    <MudCheckBox Size="Size.Small" @bind-Value="_protocol.IsArchived" Color="@Color.Primary"> @(_protocol.IsArchived == true ? "Desarquivar" : "Arquivar")</MudCheckBox>
                </MudItem>

            </MudGrid>

        </MudForm>

    </DialogContent>

    @* @* Botões de ações *@
    <DialogActions>
        <MudStack Row="true" Class="justify-end pa-4">
            <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled" Disabled="!isValid" Class="mr-3">
                Salvar
            </MudButton>
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="Cancel">
                Cancelar
            </MudButton>
        </MudStack>
    </DialogActions>

</MudDialog>

@code {

    /// <summary>
    /// A instância do diálogo do MudBlazor para controlar as ações do diálogo.
    /// É injetada automaticamente pelo framework.
    /// </summary>
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    /// <summary>
    /// Parâmetro de entrada que contém os dados do protocolo a ser editado.
    /// </summary>
    [Parameter] 
    public Protocol Protocol { get; set; } = new();

    /// <summary>
    /// Referência ao componente MudForm, usada para chamar o método de validação.
    /// </summary>
    private MudForm? form;

    /// <summary>
    /// Indicates if the form is currently valid.
    /// </summary>
    private bool isValid;

    /// <summary>
    /// Uma cópia local do objeto Protocolo para edição no formulário.
    /// Isso evita a modificação direta do objeto original antes do usuário confirmar.
    /// </summary>
    private Protocol _protocol = new();

    // Listas para armazenar dados de setores e usuários para os campos de autocomplete.
    private List<Sector> Sectors = new();
    private List<User> AllUsers = new();

    // Propriedades para armazenar os objetos selecionados nos campos de autocomplete.
    private Sector? _selectedOriginSector;
    private User? SelectedCreator;

    private Sector? _selectedDestinationSector;
    private User? SelectedDestinationUser;

    /// <summary>
    /// Propriedade que gerencia o setor de origem selecionado.
    /// Ao ser alterada, ela garante que o usuário criador seja redefinido para 'null'.
    /// </summary>
    private Sector? SelectedOriginSector
    {
        get => _selectedOriginSector;
        set
        {
            if (_selectedOriginSector != value)
            {
                _selectedOriginSector = value;
                SelectedCreator = null; // Limpa a seleção de usuário quando o setor de origem muda
            }
        }
    }

    /// <summary>
    /// Propriedade que gerencia o setor de destino selecionado.
    /// Ao ser alterada, ela garante que o usuário de destino seja redefinido para 'null'.
    /// </summary>
    private Sector? SelectedDestinationSector
    {
        get => _selectedDestinationSector;
        set
        {
            if (_selectedDestinationSector != value)
            {
                _selectedDestinationSector = value;
                SelectedDestinationUser = null; // Limpa a seleção de usuário quando o setor de destino muda
            }
        }
    }

    /// <summary>
    /// Método de ciclo de vida do componente, chamado quando ele é inicializado.
    /// Responsável por carregar os dados de setores e usuários, e preencher o formulário
    /// com as informações do protocolo recebido como parâmetro.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        // Cria uma cópia do protocolo para edição, sem afetar o original
        _protocol = new Protocol
        {
            Id = Protocol.Id,
            Number = Protocol.Number,
            Subject = Protocol.Subject,
            Description = Protocol.Description,
            OriginSectorId = Protocol.OriginSectorId,
            CreatedById = Protocol.CreatedById,
            DestinationSectorId = Protocol.DestinationSectorId,
            DestinationUserId = Protocol.DestinationUserId,
            Status = Protocol.Status,
            IsArchived = Protocol.IsArchived
        };

        // Carrega a lista de setores e usuários para os campos de autocomplete
        ICollection<Sector>? sectorsResult = await SectorService.GetAllSectorsAsync();
        Sectors = sectorsResult?.ToList() ?? new List<Sector>();

        ICollection<User>? usersResult = await UserService.GetAllUsersAsync();
        AllUsers = usersResult?.ToList() ?? new List<User>();

        // Preenche os campos de autocomplete com os dados do protocolo original
        if (_protocol.OriginSectorId != Guid.Empty)
            SelectedOriginSector = Sectors.FirstOrDefault(s => s.Id == _protocol.OriginSectorId);

        if (_protocol.CreatedById != Guid.Empty)
            SelectedCreator = AllUsers.FirstOrDefault(u => u.Id == _protocol.CreatedById);

        if (_protocol.DestinationSectorId != Guid.Empty)
            SelectedDestinationSector = Sectors.FirstOrDefault(s => s.Id == _protocol.DestinationSectorId);

        if (_protocol.DestinationUserId != Guid.Empty)
            SelectedDestinationUser = AllUsers.FirstOrDefault(u => u.Id == _protocol.DestinationUserId);

    }

    /// <summary>
    /// Função de pesquisa para o autocomplete de setores.
    /// Filtra a lista de setores com base no valor de pesquisa do usuário.
    /// </summary>
    private Task<IEnumerable<Sector>> SearchSectors(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<Sector>>(Sectors);

        return Task.FromResult(Sectors.Where(s => s.Name.Contains(value, StringComparison.OrdinalIgnoreCase) || s.Acronym.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    /// <summary>
    /// Função de pesquisa para o autocomplete de usuários, filtrando por setor de origem.
    /// Retorna uma lista de usuários que pertencem ao setor de origem selecionado.
    /// </summary>
    private Task<IEnumerable<User>> SearchUsersForOrigin(string value, CancellationToken cancellationToken)
    {
        if (SelectedOriginSector is null)
            return Task.FromResult(Enumerable.Empty<User>());

        IEnumerable<User> usersFilteredBySector = AllUsers.Where(u => u.SectorId == SelectedOriginSector.Id);

        if (string.IsNullOrEmpty(value))
            return Task.FromResult(usersFilteredBySector);

        return Task.FromResult(usersFilteredBySector.Where(u => u.FullName.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    /// <summary>
    /// Função de pesquisa para o autocomplete de usuários, filtrando por setor de destino.
    /// Retorna uma lista de usuários que pertencem ao setor de destino selecionado.
    /// </summary>
    private Task<IEnumerable<User>> SearchUsersForDestination(string value, CancellationToken cancellationToken)
    {
        if (SelectedDestinationSector is null)
            return Task.FromResult(Enumerable.Empty<User>());

        IEnumerable<User> usersFilteredBySector = AllUsers.Where(u => u.SectorId == SelectedDestinationSector.Id);

        if (string.IsNullOrEmpty(value))
            return Task.FromResult(usersFilteredBySector);

        return Task.FromResult(usersFilteredBySector.Where(u => u.FullName.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    /// <summary>
    /// Converte um valor do enum ProtocolStatus para um nome de exibição amigável.
    /// </summary>
    private string GetStatusDisplayName(ProtocolStatus status)
    {
        return status switch
        {
            ProtocolStatus.Open => "Em Aberto",
            ProtocolStatus.SentForReview => "Enviado",
            ProtocolStatus.Received => "Recebido",
            ProtocolStatus.UnderReview => "Em Análise",
            ProtocolStatus.Approved => "Aprovado",
            ProtocolStatus.Rejected => "Rejeitado",
            ProtocolStatus.CorrectionRequested => "Correção",
            ProtocolStatus.Finalized => "Finalizado",
            _ => status.ToString()
        };
    }

    /// <summary>
    /// Acionado ao clicar no botão 'Salvar'.
    /// Valida o formulário, atribui os IDs dos objetos selecionados e fecha o diálogo com o objeto Protocolo atualizado.
    /// </summary>
    private async Task Submit()
    {
        await form!.Validate();

        if (!isValid) return;

        // Validação adicional para os campos de autocomplete
        if (SelectedOriginSector is null || SelectedCreator is null || SelectedDestinationSector is null || SelectedDestinationUser is null)
        {
            Snackbar.Add("Por favor, preencha todos os campos obrigatórios de setor e usuário.", Severity.Warning);
            return;
        }

        _protocol.OriginSectorId = SelectedOriginSector.Id;
        _protocol.CreatedById = SelectedCreator.Id;
        _protocol.DestinationSectorId = SelectedDestinationSector.Id;
        _protocol.DestinationUserId = SelectedDestinationUser.Id;

        // Retorna o objeto Protocolo modificado para o componente pai.
        MudDialog.Close(DialogResult.Ok(_protocol));
    }

    /// <summary>
    /// Acionado ao clicar no botão 'Cancelar'.
    /// Cancela a operação e fecha o diálogo sem retornar dados.
    /// </summary>
    private void Cancel() 
        => MudDialog.Cancel();
}