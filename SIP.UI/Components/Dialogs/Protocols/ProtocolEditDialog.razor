@using SIP.UI.Models.Protocols
@using SIP.UI.Models.Users
@using SIP.UI.Models.Sectors
@using SIP.UI.Domain.Services.Sectors
@using SIP.UI.Domain.Services.Users
@using SIP.UI.Domain.Enums
@using MudBlazor

@inject SectorService SectorService
@inject UserService UserService
@inject ISnackbar Snackbar

<MudDialog Style="width:600px">
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="isValid" Model="_protocol">
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_protocol.Subject" Label="Assunto" For="() => _protocol.Subject" Required="true" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_protocol.Description" Label="Descrição" For="() => _protocol.Description" Required="true" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="Sector"
                                     @bind-Value="SelectedOriginSector"
                                     Label="Setor de Origem"
                                     SearchFunc="SearchSectors"
                                     For="() => SelectedOriginSector"
                                     Required="true"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Normal"
                                     ToStringFunc="@(s => s == null ? null : $"{s.Name} ({s.Acronym})")"
                                     Clearable="true"
                                     Placeholder="Pesquisar setor..."
                                     MaxItems="int.MaxValue" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="User"
                                     @bind-Value="SelectedCreator"
                                     Label="Criado Por"
                                     SearchFunc="SearchUsersForOrigin"
                                     For="() => SelectedCreator"
                                     Required="true"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Normal"
                                     Clearable="true"
                                     Placeholder="Pesquisar usuário..."
                                     ToStringFunc="@(u => u?.FullName)"
                                     Disabled="SelectedOriginSector is null"
                                     MaxItems="int.MaxValue" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="Sector"
                                     @bind-Value="SelectedDestinationSector"
                                     Label="Setor de Destino"
                                     SearchFunc="SearchSectors"
                                     For="() => SelectedDestinationSector"
                                     Required="true"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Normal"
                                     ToStringFunc="@(s => s == null ? null : $"{s.Name} ({s.Acronym})")"
                                     Clearable="true"
                                     Placeholder="Pesquisar setor..."
                                     MaxItems="int.MaxValue" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="User"
                                     @bind-Value="SelectedDestinationUser"
                                     Label="Destinado a"
                                     SearchFunc="SearchUsersForDestination"
                                     For="() => SelectedDestinationUser"
                                     Required="true"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Normal"
                                     Clearable="true"
                                     Placeholder="Pesquisar usuário..."
                                     ToStringFunc="@(u => u?.FullName)"
                                     Disabled="SelectedDestinationSector is null"
                                     MaxItems="int.MaxValue" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="ProtocolStatus" Label="Status" @bind-Value="_protocol.Status" For="() => _protocol.Status" Required="true" Variant="Variant.Outlined" Margin="Margin.Normal">
                        @foreach (ProtocolStatus status in Enum.GetValues(typeof(ProtocolStatus)))
                        {
                            <MudSelectItem Value="status">@GetStatusDisplayName(status)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6" Class="m-0">
                    <MudCheckBox Size="Size.Small" @bind-Value="_protocol.IsArchived" Color="@Color.Primary"> @(_protocol.IsArchived == true ? "Desarquivar" : "Arquivar")</MudCheckBox>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudStack Row="true" Class="justify-end pa-4">
            <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled" Disabled="!isValid" Class="mr-3">Salvar</MudButton>
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="Cancel">Cancelar</MudButton>
        </MudStack>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Protocol Protocol { get; set; } = new();

    private MudForm? form;
    private bool isValid;

    private Protocol _protocol = new();

    private List<Sector> Sectors = new();
    private List<User> AllUsers = new();

    private Sector? _selectedOriginSector;
    private User? SelectedCreator;

    private Sector? _selectedDestinationSector;
    private User? SelectedDestinationUser;

    private Sector? SelectedOriginSector
    {
        get => _selectedOriginSector;
        set
        {
            if (_selectedOriginSector != value)
            {
                _selectedOriginSector = value;
                SelectedCreator = null; // Limpa a seleção de usuário quando o setor de origem muda
            }
        }
    }

    private Sector? SelectedDestinationSector
    {
        get => _selectedDestinationSector;
        set
        {
            if (_selectedDestinationSector != value)
            {
                _selectedDestinationSector = value;
                SelectedDestinationUser = null; // Limpa a seleção de usuário quando o setor de destino muda
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _protocol = new Protocol
        {
            Id = Protocol.Id,
            Number = Protocol.Number,
            Subject = Protocol.Subject,
            Description = Protocol.Description,
            OriginSectorId = Protocol.OriginSectorId,
            CreatedById = Protocol.CreatedById,
            DestinationSectorId = Protocol.DestinationSectorId,
            DestinationUserId = Protocol.DestinationUserId,
            Status = Protocol.Status,
            IsArchived = Protocol.IsArchived
        };

        ICollection<Sector>? sectorsResult = await SectorService.GetAllSectorsAsync();
        Sectors = sectorsResult?.ToList() ?? new List<Sector>();

        var usersResult = await UserService.GetAllUsersAsync();
        AllUsers = usersResult?.ToList() ?? new List<User>();

        if (_protocol.OriginSectorId != Guid.Empty)
        {
            SelectedOriginSector = Sectors.FirstOrDefault(s => s.Id == _protocol.OriginSectorId);
        }

        if (_protocol.CreatedById != Guid.Empty)
        {
            SelectedCreator = AllUsers.FirstOrDefault(u => u.Id == _protocol.CreatedById);
        }

        if (_protocol.DestinationSectorId != Guid.Empty)
        {
            SelectedDestinationSector = Sectors.FirstOrDefault(s => s.Id == _protocol.DestinationSectorId);
        }

        if (_protocol.DestinationUserId != Guid.Empty)
        {
            SelectedDestinationUser = AllUsers.FirstOrDefault(u => u.Id == _protocol.DestinationUserId);
        }
    }

    private Task<IEnumerable<Sector>> SearchSectors(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<Sector>>(Sectors);

        return Task.FromResult(Sectors.Where(s => s.Name.Contains(value, StringComparison.OrdinalIgnoreCase) || s.Acronym.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private Task<IEnumerable<User>> SearchUsersForOrigin(string value, CancellationToken cancellationToken)
    {
        if (SelectedOriginSector is null)
            return Task.FromResult(Enumerable.Empty<User>());

        var usersFilteredBySector = AllUsers.Where(u => u.SectorId == SelectedOriginSector.Id);

        if (string.IsNullOrEmpty(value))
            return Task.FromResult(usersFilteredBySector);

        return Task.FromResult(usersFilteredBySector.Where(u => u.FullName.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private Task<IEnumerable<User>> SearchUsersForDestination(string value, CancellationToken cancellationToken)
    {
        if (SelectedDestinationSector is null)
            return Task.FromResult(Enumerable.Empty<User>());

        var usersFilteredBySector = AllUsers.Where(u => u.SectorId == SelectedDestinationSector.Id);

        if (string.IsNullOrEmpty(value))
            return Task.FromResult(usersFilteredBySector);

        return Task.FromResult(usersFilteredBySector.Where(u => u.FullName.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private string GetStatusDisplayName(ProtocolStatus status)
    {
        return status switch
        {
            ProtocolStatus.Open => "Em Aberto",
            ProtocolStatus.SentForReview => "Enviado",
            ProtocolStatus.Received => "Recebido",
            ProtocolStatus.UnderReview => "Em Análise",
            ProtocolStatus.Approved => "Aprovado",
            ProtocolStatus.Rejected => "Rejeitado",
            ProtocolStatus.CorrectionRequested => "Correção",
            ProtocolStatus.Finalized => "Finalizado",
            _ => status.ToString()
        };
    }

    private async Task Submit()
    {
        await form!.Validate();

        if (!isValid) return;

        if (SelectedOriginSector is null || SelectedCreator is null || SelectedDestinationSector is null || SelectedDestinationUser is null)
        {
            Snackbar.Add("Por favor, preencha todos os campos obrigatórios de setor e usuário.", Severity.Warning);
            return;
        }

        _protocol.OriginSectorId = SelectedOriginSector.Id;
        _protocol.CreatedById = SelectedCreator.Id;
        _protocol.DestinationSectorId = SelectedDestinationSector.Id;
        _protocol.DestinationUserId = SelectedDestinationUser.Id;

        MudDialog.Close(DialogResult.Ok(_protocol));
    }

    private void Cancel() => MudDialog.Cancel();
}