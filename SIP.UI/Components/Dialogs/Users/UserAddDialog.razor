@using MudBlazor
@using SIP.UI.Domain.DTOs.Users
@using SIP.UI.Domain.Services.Sectors
@using SIP.UI.Domain.Enums
@using SIP.UI.Models.Sectors
@using SIP.UI.Models.Users

@inject SectorService _sectorServices
@inject ISnackbar Snackbar

<MudDialog Style="width:600px">

    @* Conteúdo do diálogo *@
    <DialogContent>

        @* Formulário de adição *@
        <MudForm @ref="form" @bind-IsValid="isValid" ErrorsChanged="OnErrorsChanged">

            <MudGrid Spacing="2">

                @* Campo MASP *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="User.Masp" Label="Masp" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.ConfirmationNumber" Required="true" RequiredError="O MASP é obrigatório!" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                @* Campo nome completo *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="User.Name" Label="Name" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.PeopleOutline" Required="true" RequiredError="O nome é obrigatório!" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                @* Campo login *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="User.Login" Label="Login" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.People" Required="true" RequiredError="O login é obrigatório!" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                @* Campo email *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="User.Email" Label="Email" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Email" Required="true" RequiredError="O email é obrigatório!" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                @* Campos de Senha e Confirmação de Senha (presentes na adição) *@
                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  @bind-Value="User.Password"
                                  Label="Nova Senha"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Normal"
                                  InputType="@(showNewPassword ? InputType.Text : InputType.Password)"
                                  Required="true"
                                  RequiredError="A nova senha é obrigatória!"
                                  For="@(() => User.Password)"
                                  OnBlur="() => form!.Validate()"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(showNewPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                  OnAdornmentClick="ToggleNewPasswordVisibility" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="ConfirmPassword"
                                  Label="Confirmar Senha"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Normal"
                                  InputType="@(showConfirmPassword? InputType.Text: InputType.Password)"
                                  Required="true"
                                  RequiredError="A confirmação de senha é obrigatória!"
                                  For="@(() => ConfirmPassword)"
                                  Validation="@(new Func<string, string>(ValidateConfirmPassword))"
                                  OnBlur="() => form!.Validate()"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(showConfirmPassword? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                  OnAdornmentClick="ToggleConfirmPasswordVisibility" />
                </MudItem>

                @* Caixa de seleção para selecionar o setor do usuário *@
                <MudItem xs="12" sm="6">
                    <MudAutocomplete 
                            T="Sector" 
                            Label="Setor"
                            @bind-Value="selectedSector" 
                            SearchFunc="SearchSectors"
                            For="() => selectedSector"
                            Required="true" 
                            Dense="true" 
                            RequiredError="Selecione um setor!" 
                            Variant="Variant.Outlined" 
                            Margin="Margin.Normal"
                            ToStringFunc="@(s => s == null ? null : $"{s.Name} ({s.Acronym})")"
                            Clearable="true"
                            Placeholder="Selecione o setor..."
                            MaxItems="int.MaxValue" />
                </MudItem>

                @* Caixa de seleção para selecionar o nível de acesso do usuário *@
                <MudItem xs="12" sm="6">
                    <MudSelect T="RoleEnum" Label="Função (Role)" @bind-Value="User.Role" Required="true" Dense="true" RequiredError="Selecione uma função!" Variant="Variant.Outlined" Margin="Margin.Normal">
                        @foreach (RoleEnum role in Enum.GetValues(typeof(RoleEnum)))
                        {
                            <MudSelectItem Value="role">@GetRoleDisplayName(role)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

            </MudGrid>

        </MudForm>

    </DialogContent>

    @* Botões de ação *@
    <DialogActions>
        <MudStack Row="true" Class="justify-end pa-4">
            <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled" Disabled="!isValid" Class="mr-3">
                Salvar
            </MudButton>
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="Cancel">
                Cancelar
            </MudButton>
        </MudStack>
    </DialogActions>

</MudDialog>

@code {

    /// <summary>
    /// A instância do diálogo do MudBlazor para controlar as ações do diálogo.
    /// É injetada automaticamente pelo framework.
    /// </summary>
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    /// <summary>
    /// O objeto de usuário que será adicionado ou editado.
    /// Este parâmetro é passado pelo componente pai.
    /// </summary>
    [Parameter]
    public UserCreateDTO User { get; set; } = new();

    /// <summary>
    /// Lista completa de setores disponíveis, usada para popular o dropdown de seleção de setor.
    /// É carregada pelo serviço de setores e passada pelo componente pai.
    /// </summary>
    [Parameter]
    public ICollection<Sector>? _allSectors { get; set; }

    /// <summary>
    /// Referência para o formulário do MudBlazor.
    /// Permite disparar manualmente a validação de todos os campos.
    /// </summary>
    private MudForm? form;

    /// <summary>
    /// Flag que indica se o formulário é válido.
    /// Controla a habilitação do botão "Salvar".
    /// </summary>
    private bool isValid;

    /// <summary>
    /// Armazena o setor selecionado pelo usuário no formulário.
    /// </summary>
    private Sector? selectedSector;

    /// <summary>
    /// Flag que controla a visibilidade do campo "Nova Senha".
    /// Quando true, a senha é exibida em texto; quando false, é exibida como senha (oculta).
    /// </summary>
    private bool showNewPassword;

    /// <summary>
    /// Flag que controla a visibilidade do campo "Confirmar Senha".
    /// Quando true, a confirmação é exibida em texto; quando false, é exibida como senha (oculta).
    /// </summary>
    private bool showConfirmPassword;

    /// <summary>
    /// Valor digitado no campo "Confirmar Senha".
    /// </summary>
    private string ConfirmPassword { get; set; } = string.Empty;

    /// <summary>
    /// Executado ao inicializar o componente.
    /// Responsável por carregar os setores e preparar o formulário.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        if (_sectorServices is not null)
            _allSectors = await _sectorServices.GetAllSectorsAsync() ?? new List<Sector>();

        if (_allSectors != null && !_allSectors.Any())
        {
            Snackbar.Add(
                "Não foi possível carregar a lista de setores. O cadastro de usuários pode não funcionar corretamente.",
                severity: Severity.Warning
            );
        }

        if (User.Password != null)
            User.Password = string.Empty;

        ConfirmPassword = string.Empty;

        StateHasChanged();
    }

    /// <summary>
    /// Retorna o nome de exibição amigável para cada função (RoleEnum).
    /// </summary>
    /// <param name="role">O valor do enum RoleEnum.</param>
    /// <returns>O nome legível da função correspondente.</returns>
    private string GetRoleDisplayName(RoleEnum role)
    {
        return role switch
        {
            RoleEnum.Common => "Leitor",
            RoleEnum.SectorManager => "Gestor",
            RoleEnum.Admin => "Administrador",
            _ => role.ToString() // Caso haja um novo enum sem mapeamento, exibe o nome padrão
        };
    }

    /// <summary>
    /// Alterna a visibilidade do campo "Nova Senha".
    /// </summary>
    private void ToggleNewPasswordVisibility() =>
        showNewPassword = !showNewPassword;

    /// <summary>
    /// Alterna a visibilidade do campo "Confirmar Senha".
    /// </summary>
    private void ToggleConfirmPasswordVisibility() =>
        showConfirmPassword = !showConfirmPassword;

    /// <summary>
    /// Valida o campo "Nova Senha".
    /// </summary>
    /// <param name="value">Valor digitado no campo de senha.</param>
    /// <returns>Mensagem de erro se inválido, string vazia se válido.</returns>
    private string ValidateNewPassword(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "A nova senha é obrigatória.";

        return string.Empty;
    }

    /// <summary>
    /// Valida o campo "Confirmar Senha".
    /// </summary>
    /// <param name="value">Valor digitado no campo de confirmação.</param>
    /// <returns>Mensagem de erro se inválido, string vazia se válido.</returns>
    private string ValidateConfirmPassword(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "A confirmação de senha é obrigatória.";

        if (value != User.Password)
            return "As senhas não conferem.";

        return string.Empty;
    }


    /// <summary>
    /// Função de pesquisa para o autocomplete de setores.
    /// Filtra a lista de setores com base no valor de pesquisa do usuário.
    /// </summary>
    private Task<IEnumerable<Sector>> SearchSectors(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<Sector>>(_allSectors!);

        return Task.FromResult(_allSectors!.Where(s => s.Name.Contains(value, StringComparison.OrdinalIgnoreCase) || s.Acronym.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    /// <summary>
    /// Executado sempre que a lista de erros do formulário é alterada.
    /// Atualiza a interface do usuário.
    /// </summary>
    private void OnErrorsChanged() => 
        StateHasChanged();

    /// <summary>
    /// Executa a validação do formulário.
    /// Se válido, atribui o setor selecionado ao usuário e
    /// fecha o diálogo retornando o objeto User.
    /// </summary>
    private async Task Submit()
    {
        await form!.Validate();

        if (isValid && selectedSector != null)
        {
            User.SectorId = selectedSector.Id;

            User.Sector = selectedSector;

            MudDialog.Close(DialogResult.Ok(User));
        }
    }

    /// <summary>
    /// Cancela a operação e fecha o diálogo sem salvar alterações.
    /// </summary>
    private void Cancel() => 
        MudDialog.Cancel();
}