@using SIP.UI.Domain.Enums
@using SIP.UI.Domain.Services.Sectors
@using SIP.UI.Models.Sectors
@using SIP.UI.Models.Users
@using MudBlazor

@inject SectorService _sectorServices
@inject ISnackbar Snackbar

<MudDialog Style="width:600px">

    <DialogContent>

        @* Formulário com os campos de adição *@
        <MudForm @ref="form" @bind-IsValid="isValid" ErrorsChanged="OnErrorsChanged">

            <MudGrid Spacing="2">

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="User.Masp" Label="Masp" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.ConfirmationNumber" Required="true" RequiredError="O MASP é obrigatório!" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="User.FullName" Label="Nome Completo" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.PeopleOutline" Required="true" RequiredError="O nome é obrigatório!" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="User.Login" Label="Login" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.People" Required="true" RequiredError="O login é obrigatório!" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="User.Email" Label="Email" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Email" Required="true" RequiredError="O email é obrigatório!" Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                @* Campos de Senha e Confirmação de Senha (presentes na adição) *@
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="User.PasswordHash" Label="Senha" InputType="InputType.Password"
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Password"
                                  Required="true" RequiredError="A senha é obrigatória!"
                                  Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="ConfirmPassword" Label="Confirmar Senha" InputType="InputType.Password"
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Password"
                                  Required="true" RequiredError="A confirmação de senha é obrigatória!"
                                  Validation="@(new Func<string, IEnumerable<string>>(PasswordMatchValidation))"
                                  Variant="Variant.Outlined" Margin="Margin.Normal" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="Sector" Label="Setor" @bind-Value="selectedSector" Required="true" Dense="true" RequiredError="Selecione um setor!" Variant="Variant.Outlined" Margin="Margin.Normal">
                        @if (_allSectors != null)
                        {
                            @foreach (var sector in _allSectors)
                            {
                                <MudSelectItem Value="sector">@sector.Acronym - @sector.Name</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="RoleEnum" Label="Função (Role)" @bind-Value="User.Role" Required="true" Dense="true" RequiredError="Selecione uma função!" Variant="Variant.Outlined" Margin="Margin.Normal">
                        @foreach (RoleEnum role in Enum.GetValues(typeof(RoleEnum)))
                        {
                            <MudSelectItem Value="role">@GetRoleDisplayName(role)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

            </MudGrid>

        </MudForm>

    </DialogContent>

    <DialogActions>
        <MudStack Row="true" Class="justify-end pa-4">
            <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled" Disabled="!isValid" Class="mr-3">
                Salvar
            </MudButton>
            <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="Cancel">Cancelar</MudButton>
        </MudStack>
    </DialogActions>

</MudDialog>


@code {
    // Parâmetro em cascata para controlar a instância do diálogo (fechar, cancelar).
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    // Parâmetro para receber o objeto do usuário (novo ou para edição).
    [Parameter]
    public User User { get; set; } = new();

    // Parâmetro para receber a lista completa de setores disponíveis.
    [Parameter]
    public ICollection<Sector>? _allSectors { get; set; }

    // Referência ao componente MudForm para acionar a validação.
    private MudForm? form;

    // Flag que indica se o formulário é válido. Habilita/desabilita o botão "Salvar".
    private bool isValid;

    // Variável para armazenar o objeto Sector completo que foi selecionado no MudSelect.
    private Sector? selectedSector;

    private string ConfirmPassword { get; set; } = string.Empty;

    /// <summary>
    /// Método executado quando o componente é inicializado.
    /// É usado aqui para pré-selecionar o setor correto no modo de edição.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        // Garante que o serviço foi injetado antes de usá-lo
        if (_sectorServices is not null)
        {
            // Usa o nome da variável injetada CORRETAMENTE
            _allSectors = await _sectorServices.GetAllSectorsAsync() ?? new List<Sector>();
        }

        if (_allSectors != null && !_allSectors.Any())
        {
            // Usa a sintaxe CORRETA para o Snackbar
            Snackbar.Add(
                "Não foi possível carregar a lista de setores. O cadastro de usuários pode não funcionar corretamente.",
                severity: Severity.Warning
            );
        }

        if (User.PasswordHash != null)
        {
            User.PasswordHash = string.Empty;
        }
        ConfirmPassword = string.Empty;

        StateHasChanged();
    }

    /// <summary>
    /// Retorna o nome de exibição personalizado para cada UserRole.
    /// </summary>
    /// <param name="role">O valor do UserRole.</param>
    /// <returns>A string de exibição correspondente.</returns>
    private string GetRoleDisplayName(RoleEnum role)
    {
        return role switch
        {
            RoleEnum.Common => "Leitor",
            RoleEnum.SectorManager => "Gestor",
            RoleEnum.Admin => "Administrador",
            _ => role.ToString() // Caso haja um novo enum sem mapeamento, exibe o nome padrão
        };
    }

    // Método de validação de igualdade de senhas
    private IEnumerable<string> PasswordMatchValidation(string confirmPasswordValue)
    {
        if (string.IsNullOrEmpty(confirmPasswordValue))
        {
            yield return "A confirmação de senha é obrigatória!";
            yield break;
        }

        if (confirmPasswordValue != User.PasswordHash)
        {
            yield return "As senhas não correspondem!";
        }
    }

    /// <summary>
    /// Called when form errors change to update the UI.
    /// </summary>
    private void OnErrorsChanged() => 
        StateHasChanged();

    /// <summary>
    /// Valida o formulário e, se for válido, fecha o diálogo retornando os dados.
    /// </summary>
    private async Task Submit()
    {
        // Força a validação de todos os campos do formulário.
        await form!.Validate();

        // Se o formulário for válido e um setor tiver sido selecionado...
        if (isValid && selectedSector != null)
        {
            // ...atribui o ID do setor selecionado ao objeto User.
            User.SectorId = selectedSector.Id;
            // (Opcional) Você também pode atribuir o objeto inteiro se for útil.
            User.Sector = selectedSector;

            // Fecha o diálogo com sucesso, retornando o objeto User modificado.
            MudDialog.Close(DialogResult.Ok(User));
        }
    }

    /// <summary>
    /// Cancela a operação e fecha o diálogo sem salvar.
    /// </summary>
    private void Cancel() => 
        MudDialog.Cancel();
}